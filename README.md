# Invoices Platform

Monorepo for a multi-language invoices system:

Go service (api-go) — REST API (health, invoices, etc.)

Python workers (workers-py) — fetching & processing invoices (Gmail/Outlook, links, attachments)

n8n — automation glue (webhooks/notifications)

Postgres + RabbitMQ — storage & async backbone

Docker Compose & Dev Container — one-command local dev

PDFs are stored on a local volume during development; metadata goes to Postgres.

```

invoices-platform/
├─ apps/
│  ├─ api-go/
│  │  ├─ cmd/invoicer/main.go
│  │  ├─ internal/
│  │  │  ├─ domain/
│  │  │  ├─ usecase/
│  │  │  └─ adapters/
│  │  ├─ go.mod
│  │  └─ Makefile
│  └─ workers-py/
│     ├─ src/
│     │  ├─ invplatform/
│     │  │  ├─ __init__.py
│     │  │  ├─ domain/{constants.py,files.py,pdf.py,relevance.py}
│     │  │  ├─ adapters/{__init__.py,base.py}
│     │  │  ├─ usecases/{__init__.py,fetch_invoices.py}
│     │  │  └─ cli/{__init__.py,gmail_invoice_finder.py,graph_invoice_finder.py}
│     │  ├─ workers/                # job runners (future)
│     │  ├─ pipelines/              # ETL steps (future)
│     │  └─ adapters/               # legacy scaffolding (to fold into invplatform)
│     ├─ tests/
│     ├─ pyproject.toml
│     ├─ uv.lock                    # generated by uv (optional)
│     ├─ Makefile
│     └─ README.md
├─ integrations/
│  ├─ n8n/
│  │  ├─ n8n.env.example
│  │  └─ workflows/                 # export your n8n workflows here
│  └─ openapi/
│     └─ invoices.yaml
├─ deploy/
│  ├─ compose/
│  │  └─ docker-compose.dev.yml
│  ├─ docker/
│  │  ├─ Dockerfile.api-go
│  │  └─ Dockerfile.workers-py
│  └─ k8s/                          # later
├─ docs/
│  ├─ ADR/
│  │  └─ 0001-monorepo.md           # rationale (optional)
│  ├─ ONBOARDING.md
│  ├─ ARCHITECTURE.md
│  └─ CONTRIBUTING.md
├─ .devcontainer/
│  ├─ devcontainer.json
│  └─ Dockerfile
├─ .github/workflows/ci.yml
├─ .pre-commit-config.yaml
├─ .env.example
├─ storage/                         # local PDFs (dev only; add to .gitignore)
├─ Makefile
└─ README.md

```

CLI scripts (e.g., `python -m invplatform.cli.graph_invoice_finder`) now reuse helpers from `apps/workers-py/src/invplatform/domain`, and the `adapters` / `usecases` packages act as scaffolding for the upcoming orchestration layer.

## Email Discovery Toolkit

Utility scripts for ad-hoc invoice hunting live under `archive/` and evolve across versions. Older scripts are kept for comparison/debugging, while `archive/graph_invoice_finder.v3.5.2.py` is the recommended entry point.

### Graph Invoice Finder (v3.5.2)

- Uses Microsoft Graph `$search` queries (Hebrew + English keywords) with client-side scoring to surface invoices, receipts, and payment confirmations.
- Supports sender/domain boosting, negative keywords, subject regex boosts, and trusted provider lists so you can tune relevance without patching code.
- Provides validation helpers (`--explain`, `--threshold-sweep`, `--save-candidates`, `--save-nonmatches`) plus optional attachment download for final matches.
- Emits JSON/CSV exports and per-strategy summaries to help validate coverage before wiring results back into the pipeline.

Quick start (requires `msal`, `pandas`, `requests`):

```bash
python archive/graph_invoice_finder.v3.5.2.py \
  --client-id "<entra_public_client_id>" \
  --lookback-days 90 \
  --out-json outputs/invoices.json \
  --out-csv outputs/invoices.csv \
  --threshold-sweep 0.30,0.45,0.55
```

### Outlook Search Filters

The files `search_filter_outlook.v1.json` and `search_filter_outlook.v2.json` capture Outlook portal saved searches that mirror the script heuristics (keyword mix, date windows). Importing them is useful when you want to eyeball results inside Outlook before running the automation end-to-end.

## Running tests

Lightweight confidence tests cover the keyword heuristics in the standalone Gmail/Graph invoice finders. To execute them (no live API dependencies required):

```bash
pytest tests/test_invoice_finders.py
```

## Running invoice finder scripts

You can trigger the standalone Gmail / Outlook fetchers via Make targets (pass the required date range and extra flags via variables):

```bash
# Gmail (add flags like GMAIL_EXTRA_ARGS="--verify --exclude-sent")
make run-gmail START_DATE=2025-06-01 END_DATE=2025-07-01

# Microsoft Graph (client id is required; extra flags via GRAPH_EXTRA_ARGS)
make run-graph START_DATE=2025-06-01 END_DATE=2025-07-01 GRAPH_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx GRAPH_EXTRA_ARGS="--exclude-sent --verify"

# Manual invocation (Makefile already exports PYTHONPATH automatically)
PYTHONPATH=apps/workers-py/src python -m invplatform.cli.gmail_invoice_finder --help
```

### Current-month one-liner

- Run both providers for the current month and consolidate PDFs:
  `make run-monthly GRAPH_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- Output layout under the repo root by default: `invoices/invoices_gmail_MM_YYYY`, `invoices/invoices_outlook_MM_YYYY`, and a merged `invoices/invoices_MM_YYYY` (with `run_summary.json`).
- Parallel by default; force sequential with `MONTHLY_SEQUENTIAL=1`.
- Backfill a specific month with `MONTH=10 YEAR=2025 make run-monthly ...`.
- Narrow to a single provider with `MONTHLY_PROVIDERS=gmail` (or `outlook`).
- Forward extra CLI flags per provider:
  `MONTHLY_GMAIL_ARGS="--exclude-sent --verify"` and
  `MONTHLY_GRAPH_ARGS="--exclude-sent --verify --explain"`.

### Local n8n scheduler (MVP)

Goal: run `make run-monthly` daily via n8n, no extra services.

1) Start n8n (dev compose only):
   `make run-n8n`
2) Open `http://localhost:5678` and create a workflow:
   - Trigger: Cron (daily at your preferred time).
   - Action: Execute Command
     - Command: `make -C /workspace run-monthly MONTHLY_PROVIDERS=gmail`
3) Ensure Gmail OAuth files exist in the repo root:
   - `credentials.json` and `token.json` (generate once locally on the host if needed).
   - The n8n container cannot open a browser for OAuth; run a local Gmail auth once to create a refreshable `token.json`.

Notes:
- The n8n container mounts the repo at `/workspace`, so outputs land in `invoices/` under the repo root.
- To run Gmail-only, use `MONTHLY_PROVIDERS=gmail`. For Outlook, set `GRAPH_CLIENT_ID`.
