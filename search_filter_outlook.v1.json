{
    "version": "1.0",
    "notes": {
        "graph_facts": [
            "Use `$search` for subject/body keyword search; set header `ConsistencyLevel: eventual` and include `$count=true` when mixing with `$filter`.",
            "You CAN filter messages with `hasAttachments eq true` and by `receivedDateTime`.",
            "You CANNOT filter attachment file types at the /messages or /attachments list endpoints; detect extensions client-side.",
            "Use `$top` in pages (e.g., 50–200) and iterate with `@odata.nextLink`."
        ]
    },
    "query_defaults": {
        "endpoint_base": "https://graph.microsoft.com/v1.0/me/messages",
        "headers": {
            "ConsistencyLevel": "eventual"
        },
        "params_common": {
            "$count": "true",
            "$top": "100",
            "$select": "id,subject,from,receivedDateTime,hasAttachments,bodyPreview,webLink",
            "$orderby": "receivedDateTime desc"
        },
        "lookback_days": 120
    },
    "keyword_sets": {
        "hebrew_core": [
            "חשבונית",
            "חשבונית מס",
            "קבלה",
            "אסמכתא",
            "תשלום",
            "דרישת תשלום",
            "קבלה מס",
            "חשבונית מס קבלה",
            "חיוב",
            "זיכוי",
            "שובר תשלום"
        ],
        "english_core": [
            "invoice",
            "tax invoice",
            "receipt",
            "payment receipt",
            "billing statement",
            "payment request",
            "charge",
            "credit note"
        ],
        "hebrew_context": [
            "מספר חשבונית",
            "סכום לתשלום",
            "יתרה לתשלום",
            "פירוט חיובים",
            "לצפייה בחשבונית",
            "הורדה",
            "הורד קובץ",
            "קישור לחשבונית"
        ],
        "english_context": [
            "invoice number",
            "amount due",
            "balance due",
            "view invoice",
            "download invoice",
            "download receipt",
            "statement"
        ]
    },
    "attachment_detection": {
        "extensions_prefer": [
            ".pdf",
            ".tif",
            ".tiff",
            ".jpg",
            ".jpeg",
            ".png",
            ".xlsx",
            ".xls"
        ],
        "name_hints": [
            "invoice",
            "receipt",
            "חשבונית",
            "קבלה"
        ]
    },
    "link_detection": {
        "require_https": true,
        "url_keywords": [
            "invoice",
            "receipt",
            "statement",
            "bill",
            "חשבונית",
            "קבלה",
            "תשלום",
            "payment",
            "download"
        ],
        "trusted_providers": [
            "greeninvoice.co.il",
            "icount.co.il",
            "ezcount.co.il",
            "priority-software.com",
            "sap.com",
            "zoho.com",
            "xero.com",
            "quickbooks.intuit.com",
            "stripe.com",
            "paypal.com",
            "wix.com",
            "shopify.com",
            "tax.gov.il",
            "gov.il",
            "freshbooks.com",
            "waveapps.com"
        ],
        "heuristics": {
            "path_patterns": [
                "invoice",
                "receipt",
                "billing",
                "payments",
                "download",
                "documents",
                "חשבונית",
                "קבלה",
                "תשלום"
            ],
            "file_like_suffixes": [
                ".pdf",
                ".html",
                ".aspx"
            ]
        }
    },
    "graph_query_strategies": [
        {
            "name": "attachments_and_keywords_recent",
            "description": "Invoices with attachments, recent window.",
            "params": {
                "$filter": "(hasAttachments eq true) and (receivedDateTime ge {ISO_UTC_NOW_MINUS_LOOKBACK})",
                "$search": "\"invoice OR receipt OR חשבונית OR קבלה\""
            }
        },
        {
            "name": "keywords_only_recent",
            "description": "Catches link-only invoices (no attachments).",
            "params": {
                "$filter": "receivedDateTime ge {ISO_UTC_NOW_MINUS_LOOKBACK}",
                "$search": "\"(invoice OR receipt OR statement OR billing OR חשבונית OR קבלה OR תשלום)\""
            }
        },
        {
            "name": "hebrew_bias",
            "description": "Bias toward Hebrew terms (your majority).",
            "params": {
                "$filter": "receivedDateTime ge {ISO_UTC_NOW_MINUS_LOOKBACK}",
                "$search": "\"(חשבונית OR \\\"חשבונית מס\\\" OR קבלה OR תשלום OR \\\"חשבונית מס קבלה\\\")\""
            }
        },
        {
            "name": "provider_whitelist_bump",
            "description": "Prioritize known invoice providers by simple body search.",
            "params": {
                "$filter": "receivedDateTime ge {ISO_UTC_NOW_MINUS_LOOKBACK}",
                "$search": "\"(greeninvoice.co.il OR icount.co.il OR ezcount.co.il OR quickbooks.intuit.com OR stripe.com OR paypal.com OR zoho.com OR xero.com OR shopify.com OR tax.gov.il)\""
            }
        }
    ],
    "client_side_postprocessing": {
        "attachment_rules": [
            "If message.hasAttachments is true, call /me/messages/{id}/attachments and keep FileAttachment, ItemAttachment.",
            "Accept attachments whose name contains any of `attachment_detection.name_hints` OR extension in `attachment_detection.extensions_prefer`.",
            "Treat S/MIME (.p7m) envelopes specially: if contentType indicates smime, you may need to decode to reach the inner PDF."
        ],
        "link_rules": [
            "Extract all https? links from body (prefer HTML body if available).",
            "Keep links from `trusted_providers` OR whose path contains any `link_detection.path_patterns` OR whose text/URL contains any `url_keywords`.",
            "Prefer links that end with known file suffixes (e.g., .pdf) or include query parameters like `invoice`, `receipt`, `doc`, `download`."
        ],
        "language_scoring": {
            "he_weight": 1.2,
            "en_weight": 1.0,
            "signals": [
                "keyword_hits_hebrew_core",
                "keyword_hits_english_core",
                "context_hits"
            ]
        },
        "min_confidence_threshold": 0.55
    },
    "output_fields": [
        "id",
        "subject",
        "from.emailAddress.address",
        "receivedDateTime",
        "hasAttachments",
        "matched_strategy",
        "match_confidence",
        "matched_keywords",
        "matched_links",
        "matched_attachments",
        "webLink"
    ]
}
